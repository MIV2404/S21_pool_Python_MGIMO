# Ботоводство

## Contents

1. [Chapter I](#chapter-i) \
    1.1. [Introduction](#introduction)
2. [Chapter II](#chapter-ii) \
    2.1. [Information](#information)
3. [Chapter III](#chapter-iii) \
    3.1. [Обзор ботов](#обзор-ботов) \
    3.6. [Декораторы](#декораторы) \
    3.2. [Task 1](#task-1) \
    3.3. [PyTelegramBotAPI](#pytelegrambotapi) \
    3.4. [Task 2](#task-2) \
    3.5. [Хранение состояния пользователей](#хранение-состояния-пользователей) \
    3.7. [Task 3](#task-3) \
    3.8. [Клавиатуры Reply и Inline](#клавиатуры-reply-и-inline) \
    3.9. [Task 4](#task-4) \
    3.10. [Task 5](#task-5) 

## Chapter I

### Introduction

Привет, студент!

Сегодня ты научишься создавать своих telegram-ботов. Да-да! Тех самых телеграм-ботов, которыми все мы активно пользуемся, ведь почти все они написаны именно на Python!

## Chapter II

### Information

Не забывай, что наше обучение строится по принципу "равный равному" (P2P, peer-to-peer). P2P – это способ обучения, когда студенты помогают друг другу при возникновении каких-либо сложностей. Если ты столкнулся с чем-то непонятным, первым делом спроси у своих товарищей по курсу. Если ответа ты не получил, то обратись к Google. А получив ответ на свой вопрос, не забудь поделиться им с другими студентами!


Также хотим тебе напомнить, что перед выполнением задач нужно скопировать задания из папки `materials` в папку `src`, и выполнять всё нужно соответственно в `src`. Это можно сделать следующей командой:
```
cp -R materials/* src/
```

## Chapter III

### Обзор ботов

Начнем с краткого обзора телеграм-ботов

Что же такое эти телеграм-боты? Бот – небольшое приложение, которое умеет решать определенный перечень задач, заложенный в него без участия человека. Для пользователя бот выглядит как обычный чат. Бот может присылать пользователю автоматически или по запросу текстовые сообщения (в т.ч. ссылки), картинки, видео или файлы – смотря в чем заключается его назначение. Тг-боты используются для многих задач. 

Сегодня, в эпоху развития нейросетей, крайне популярны боты, предоставляющие бесплатный и удобный доступ к популярным нейросеткам: к чату GPT, Midjourney и другим. Тг-ботов создают себе сервисы заказа еды, интернет-магазины, СМИ и другие организации. Боты используются даже как сервисные IT-службы, например, для оповещения о времени работы и неисправностях аппаратуры. Мы в тобой в ходе этого дня тоже разработаем телеграм-бота!

### Декораторы

Но прежде чем начать, разберемся с одной конструкцией языка Python, которая тебе непременно понадобится, – с декораторами. Мы с тобой уже умеем создавать функции и методы. Декоратор же – это обертка вокруг функции или метода, которая меняет способ его работы. При этом не нужно менять исходный код функции. По своей сути декоратор – это функция, которая принимает в качестве параметра функцию и возвращает также функцию, но модифицированную. Сейчас разберем небольшой пример, где покажем, как создаются и применяются декораторы:

```
# здесь мы определяем функцию декоратора (создаем декоратор)
def extend(input_function):
    def output_function():  # определяем функцию с модифицированным функционалом, которая заменит входную
        print("Привет!")  # Новый функционал будет заключаться в дополнительном выводе сообщений перед и после функции
        input_function()  # вызываем исходную, переданную в параемтре функцию
        print("Я уже дошел аж до четвертого проекта второй недели!")
    return output_function()  # возвращаем новую функцию

# основная функция
@extend # применяем декоратор к функции, используя вот такой синтаксис
def introduce_me(): # определяем исходную функцию
    print("Я студент Школы 21!")


# вызов основной функции, на которую мы применили декоратор
introduce_me()
```
Разбираем всё по кусочкам. В самом начале мы создаем сам декоратор, т.е. определяем функцию, которая принимает на вход другую функцию (ту, к которой будет применяться декоратор) и возвращает новую функцию.

Далее мы создаем функцию, которую мы хотим модифицировать декоратором: 

```
def introduce_me(): # определяем исходную функцию
    print("Я студент Школы 21!")
```

И применяем к ней декоратор ‘@extend’, т.е. на 1 строчку выше пишем название функции-декоратора перед этим поставив ‘@’.

Затем вызываем нашу функцию, как мы это всегда делали, и смотрим результат!

```
Привет!
Я студент Школы 21!
Я уже дошел аж до четвертого проекта второй недели!

```

Наша функция была модифицирована!

Кстати, если бы не написали над изначальной функцией ‘@extend’, то того же результата можно было бы достичь, вызвав не саму функцию, а функцию декоратор, куда начальная функция передается, как параметр:

```
extend(introduce_me)
```

Декораторы, хотя и выглядят незнакомо, по своей сути очень просты и удобны в использовании. Сейчас мы разобрали пример с простым декоратором, но у декораторов могут быть и параметры: 
```
@extend(2, 4)
```
Такие декораторы позволяют модифицировать функцию, используя переданные им параметры. О том как они устроены советуем узнать самостоятельно. А мы тем временем переходим к первому заданию!

### Task 1

В этом задании попрактикуемся в работе с декораторами:

Пусть есть семейство функций, анализирующих текст с сигнатурой: def f(txt:str) (о том что такое сигнатура спроси у Google). В тексте могут быть числа, но они совершенно не нужны. 
1. Тебе нужно написать такой декоратор, который заменяет во входном тексте все числа на их словесные обозначения.
2. Провести ряд операций над текстом: разбить текст на отдельные слова, найти все уникальные слова и убрать из текста знаки пунктуации. 

Само задание находится здесь: `materials/task1/decorators.py`

Файл с решением сохрани в папку 'src'.

### PyTelegramBotAPI

Отлично! Мы разобрались с декораторами и можем приступать к созданию бота! Давай посмотрим как это делается!

Боты в Telegram создаются через специального бота `@BotFather` (Найди его в Telegram). Пишем команду `/start` -> `/newbot` и следуем инструкциям. Когда вы создадите бота, BotFather выдаст вам токен. Токен это такая уникальная строка символов, которая присваивается каждому созданному боту. С помощью неё вы ботом и управляете.

Мы создали бота, но пока он ничего не умеет. Чтобы добавить нашему боту функционал, мы должны написать программу на Python и связать её с ботом. Для этого мы установим PyTelegramBotAPI, как обычно, воспользовавшись pip. PyTelegramBotAPI – это довольно популярный и простой в использовании фреймворк для создания бота. Теперь самое время научить нашего бота обрабатывать сообщения от пользователя. Для начала свяжем бота с программой:

```
import telebot
bot = telebot.TeleBot('Your-token')
```

Теперь нам нужно, чтобы бот обрабатывал сообщения. Здесь нам как раз и понадобятся декораторы:

```
@bot.message_handler(content_types=['text'])
def get_text_messages(message):
	…
    bot.send_message(message.from_user.id, some_text) # Отправка some_text пользователю с определённым id (берем его из полученного от пользователя сообщения)
```

В этом коде к функции, которая будет обрабатывать сообщения от бота приписывается декоратор в параметры которого можно внести тип переданных от пользователя данных, на которые будет реагировать данная функция, как это сделано в примере. Также можно ввести перечень команд (сообщений, которые начинаются с "/"), на которые бот реагирует. 
Обработчиков, само собой, может быть несколько: 
```
@bot.message_handler(commands=['command1', 'command_1']) # Через запятую пишем названия команды.
def react_command1(message):
	…
    bot.send_message(message.from_user.id, text)

@bot.message_handler(commands=['command2', 'command_2']) 
def react_command2(message):
	…
	bot.send_message(message.from_user.id, text)
```
Когда все обработчики написаны, нужно сделать так, чтобы бот мог читать сообщения от пользователей. Мы будем использовать самый простой метод – поллинг. Суть его заключается в том, что мы спрашиваем у бота раз в несколько секунд, не получал ли он сообщения? Если получал, то мы его считываем и обрабатываем. Есть и другие методы считывания сообщений пользователя, к примеру веб-хуки, но о них ты можешь узнать самостоятельно, используя Google.

```
bot.polling()
```

Теперь после запуска программы вы сможете отправлять боту сообщения и команды, а он сможет на них реагировать! Пришло время выполнить второе задание. *Помни, задания 2-5 выполняй в отдельных файлах, чтобы проверка прошла успешно!*

### Task 2 

В этом задании тебе нужно завести тг-бота, запомнить токен, создать простейший обработчик текстовых команд, который отвечает тем же текстом, что ему ввели. Более подробно задание описано в директории `materials/tg_bot/bot1.py` (задание 1).

Сохрани результаты в папке 'src'.

### Хранение состояния пользователей

Часто при создании ботов возникает необходимость хранить данные (состояние) пользователей, например, их id и возраст.  В больших проектах этот аспект реализуется при помощи взаимодействия с базой данных через СУБД. Одной из самых популярных СУБД для этих целей является Redis. Мы же в проекте обойдемся простым глобальным словарём (вспомни про ключевое слово ‘global’). Если же тебя заинтересовала тема работы с базами данных, то можешь самостоятельно почитать о том, что такое СУБД и Redis и как они взаимодействуют с программой. Итак, задание 3:

### Task 3

В этом задании тебе предстоит улучшить бота: добавить ему новый функционал, а именно функции, которые обрабатывают следующие команды:
- /age
- /name
- /help

Более подробно задание описано в директории `materials/tg_bot/bot2.py` (задание 2).

Не забудь сохранить результаты в папке 'src'. 

### Клавиатуры Reply и Inline

Если ты часто пользовался ботами, то наверняка замечал, что во время использования бота привычная клавиатура может превращаться в кнопки! Такая клавиатура называется Reply это обычная клавиатура, но управляемая ботом. Inline — это клавиатура, которая отображается под сообщениями бота. Данная клавиатура отправляет боту данные, привязанные к нажатой кнопке.

Для начала поговорим о клавиатуре reply. Создавать такую клавиатуру довольно просто. Для этого в нужном вам обработчике событий создается объект разметки reply-клавиатуры (ReplyKeyboardMarkup). На этот объект накладываются все нужные кнопки и всё! Вот небольшой пример:

```
import telebot
from telebot import types
…
@bot.message_handler(...)
def some_handler(message):
   reply_markup = types.ReplyKeyboardMarkup(resize_keyboard=True) # Создаем объект разметки клавиатуры
   btn1 = types.KeyboardButton("Привет!") # Создаем кнопки на клавиатуре
   btn2 = types.KeyboardButton("Расскажи анекдот!")
   reply_markup.add(btn1, btn2) # Добавляем кнопки на объект разметки
   bot.send_message('user_id', text = "some_text", reply_markup = reply_markup) # Как обычно выводим сообщение, но указываем, что пользователь увидит reply-клавиатуру.
```

Теперь Inline. На клавиатуру Inline можно поместить 3 типа кнопок: URL, Switch и Callback кнопки. Кнопки первого типа, после соответствующего предупреждения переносят пользователя по какому-либо URL-адресу. Кнопки второго типа предназначены для перенаправления пользователя в какой-либо чат (об этом можешь подробнее узнать в Google). Создаются они ничуть не сложнее, чем кнопки на клавиатуре Reply:

```
@bot.message_handler(...)
def some_handler(message):
   markup = types.InlineKeyboardMarkup() # Создаем объект разметки клавиатуры.
   btn_url = types.InlineKeyboardButton(text='Новости', url='https://ria.ru/') # Создаем кнопку URL.
   btn_switch = types.InlineKeyboardButton(text='Telegram', switch_inline_query="Telegram") # Создаем кнопку Switch.
   btn_callback = types.InlineKeyboardButton(text='Мой возраст 20 лет', callback_data = 20) # Создаем кнопку Callback. callback_data - это данные которые передаются при нажатии на кнопку.
   markup.add(btn_url, btn_switch, btn_callback) # Добавляем кнопки на объект разметки
   bot.send_message('user_id', "some_text", reply_markup = markup) # Как обычно выводим сообщение, но указываем, что пользователь увидит inline-клавиатуру.

```

Теперь поговорим про самый интересный тип кнопок – Callback-кнопки или кнопки с обратной связью. Они позволяют боту получать уведомление о нажатиях на кнопки без отправки сообщения от пользователя, после чего выполнять необходимое действие. В примере выше мы уже создали кнопку callback. Однако как именно мы сможем получать уведомление о нажатии на эту кнопку, если никакого сообщения бот не отправляет? Дело в том, что при нажатии на кнопку вместо сообщения, пользователь отправляет callback-запрос (тип данных CallbackQuery). Выходит, теперь нам нужно создать не обработчик текстовых сообщений, а обработчик таких запросов:

```
@bot.callback_query_handler(func = lambda call: True) # Такой параметр декоратора обеспечивает обработку нажатия всех inline-кнопок.
def callback_inline(call): # определяем обработчик.
   if call.data: ... # Если были получены какие-то данные при нажатии на кнопку, мы их обработаем.
```

### Task 4

Продолжаем улучшать бота. Сегодня тебе предстоит:
1. перенести команду /help в отдельное меню
2. создать кнопки, чтобы поиграть с пользователем в угадайку😃

Более подробно задание описано в директории `materials/tg_bot/bot3.py` (задание 3).

Сохрани результаты в папке 'src'.

### Task 5

Последний апгрейд:

Тебе предстоит добавить дополнительные кнопки в интерфейс нашего бота.

Более подробно задание описано в директории `materials/tg_bot/bot4.py` (задание 4).

Сохрани результаты в папке 'src'.

>Пожалуйста, оставьте обратную связь по проекту в [форме обратной связи.](https://forms.gle/HeZn9uKP3cw1Tyoz5)
